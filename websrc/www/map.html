<!DOCTYPE html>
<html LANG="ko">
<div id="mapview_page" data-sn='' data-sigcd='' data-role="page" data-dom-cache="true">
    <div id="map" style="height: 100%;"></div>
    <div id="popup" class="mapWrap">
        <div class="mapRow">
            <span class="box1"></span>
            <div class="box2"></div>
            <span class="box3"></span>
        </div>
        <div id="popup-content" class="mapContent">
        </div>
        <div class="mapRow">
            <span class="box7"></span>
            <div class="box8"></div>
            <span class="box9"></span>
        </div>
    </div>
    <div id="marker"><img src="img/icon_curMarker.png" /></div>

    <script type="text/javascript">
        $(document).on("pagecreate", pages.map.div, function() {
        });

        $(document).on("pagehide", pages.map.div, function(event, data) {

        });

        $(document).on("pagebeforeshow", pages.map.div, function(event, data) {
        });

        $(document).on("pageshow", pages.map.div, function() {
            
            var context = app.context;

            if (util.isEmpty(context)){
                map.updateSize(); //카메라 다녀온후 지도 안보여서 추가
                return;
            }

            var pos = ol.proj.fromLonLat([localStorage["loc.X"], localStorage["loc.Y"]], baseProjection);

            mapInit("map", pos).then(function() {
                //심플팝업 초기화
                $("#popup-content").empty();
                $("#popup").hide();

                if (context.type == "map") {
                    $(".legend").toggle(true);
                    map.removeLayer(layers.move);
                    map.removeLayer(layers.buld);
                    map.addLayer(layers.rdpq);
                    map.addLayer(layers.bsis);
                    map.addLayer(layers.area);
                } else {
                    $(".legend").toggle(false);
                    map.removeLayer(layers.move);
                    map.removeLayer(layers.rdpq);
                    map.removeLayer(layers.bsis);
                    map.removeLayer(layers.area);
                    map.addLayer(layers.buld);
                    // map.addLayer(layers.entrc);
                }
            });

            app.context = {};
        });

        $(document).on("focus", "#mapview_memo", function() {
            $('#map_keypad_opt').removeClass('display-none');
        });

        $(document).on("focusout", "#mapview_memo", function() {
            $('#map_keypad_opt').addClass('display-none');
        });

        $("#write_memo").on("click", function() {
            showMemoInput({});
        });

        $("#viewportline").on("click", function() {
            $('.centerline').toggleClass('displaynone');
        });

        function showMemoInput(jsonData) {
            var memocontainer = $('#mapview_page > .memo-container');
            var top = ($('.titleheader').outerHeight() + 10) + 'px';
            memocontainer.css('top', top);
        }

        function hideMemoInput() {
            var memocontainer = $('#mapview_page > .memo-container');
            var top = '-12em';
            memocontainer.css('top', top);
        }

        function memoAccept() {
            var memo = {
                date: util.getToday(true),
                memo: $('#mapview_memo').val(),
                x: 0,
                y: 1,
                jsons: {}
            }
            datasource.addMemo(memo);

            memoFlush();
        }

        function memoFlush() {
            $('#mapview_memo').val('');
            hideMemoInput();

            datasource.memoList({}, function(dataArray) {
                console.log(dataArray);
                for (data in dataArray) {
                    console.log(data);
                }
            });
        }

        function viewportline() {

            var canvas = document.getElementById('centerlineCv');

            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');

                var deviceRatio = window.devicePixelRatio;
                var backingStoreRatio = ctx.webkitBackingStorePixelRatio ||
                    ctx.mozBackingStorePixelRatio ||
                    ctx.msBackingStorePixelRatio ||
                    ctx.oBackingStorePixelRatio ||
                    ctx.backingStorePixelRatio || 1;
                var ratio = deviceRatio / backingStoreRatio;

                canvas.width = $('#centerlineCv').width() * ratio;
                canvas.height = $('#centerlineCv').height() * ratio;
                ctx.scale(ratio, ratio);

                var x = canvas.clientWidth / 2;
                var y = canvas.clientHeight / 2;
                ctx.clearRect(0, 0, x, y);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, 2 * y);
                ctx.moveTo(0, y);
                ctx.lineTo(2 * x, y);
                ctx.strokeStyle = '#888888';
                ctx.stroke();
            }
        }
    </script>
</div>
